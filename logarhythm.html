<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Formatter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0d0d0d;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .editor-panel {
            width: 45%;
            min-width: 400px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .panel-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .section {
            background: #222;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .section-header {
            padding: 12px 16px;
            background: #2a2a2a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-header:hover {
            background: #333;
        }

        .section-header h3 {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .section-header .toggle-icon {
            transition: transform 0.2s;
        }

        .section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .section-content.hidden {
            display: none;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary { background: #4a9eff; color: #fff; }
        .btn-primary:hover { background: #3a8eef; }
        .btn-secondary { background: #444; color: #e0e0e0; }
        .btn-secondary:hover { background: #555; }
        .btn-warning { background: #ff9f43; color: #000; }
        .btn-warning:hover { background: #ffaf53; }
        .btn-danger { background: #ff6b6b; color: #fff; }
        .btn-danger:hover { background: #ff5252; }
        .btn-success { background: #51cf66; color: #000; }
        .btn-success:hover { background: #40bf55; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .form-row .form-group {
            flex: 1;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 0.85rem;
            width: 100%;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }

        input[type="color"] {
            width: 40px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: #444;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: #4a9eff;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle.active::after {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 0.85rem;
        }

        .preview-panel {
            flex: 1;
            background: #111;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-header {
            padding: 16px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-frame {
            min-height: 200px;
        }

        .edit-textarea {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            resize: vertical;
        }

        .output-section {
            border-top: 1px solid #333;
            padding: 16px 20px;
            background: #1a1a1a;
        }

        .output-textarea {
            width: 100%;
            height: 150px;
            background: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 12px;
        }

        .style-property {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
        }

        .style-property-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }

        .style-property-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .style-property-input input,
        .style-property-input select {
            flex: 1;
        }

        .quote-mapping {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
        }

        .quote-mapping .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .quote-mapping select {
            flex: 1;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: #222;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .modal p {
            margin-bottom: 20px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .modal .btn-group {
            justify-content: flex-end;
        }

        .hidden {
            display: none !important;
        }

        .summary-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .summary-input-group label {
            font-size: 0.8rem;
            color: #aaa;
            min-width: 80px;
        }

        .summary-input-group input {
            flex: 1;
        }

        .image-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .image-controls input[type="file"] {
            display: none;
        }
		
        .gradient-editor {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 4px;
        }

        .pill-editor {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .pill-editor input[type="text"] {
            flex: 1;
            min-width: 80px;
        }

        .pill-editor input[type="color"] {
            width: 32px;
            height: 28px;
        }

        .pill-editor-colors {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pill-editor-colors label {
            font-size: 0.7rem;
            color: #888;
        }

        .pill-preview {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            white-space: nowrap;
            line-height: 1.4;
            display: inline-flex;
            align-items: center;
            min-height: 24px;
        }

        .gradient-stop {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gradient-stop input[type="color"] {
            width: 32px;
            height: 24px;
        }

        .gradient-stop input[type="number"] {
            width: 60px;
        }

        .gradient-preview {
            height: 24px;
            border-radius: 4px;
            border: 1px solid #555;
            margin-top: 4px;
        }

        .border-editor {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .border-editor input[type="number"] {
            width: 60px;
        }

        .border-editor select {
            width: 100px;
        }

        .border-editor input[type="color"] {
            width: 32px;
            height: 28px;
        }

        .color-with-alpha {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .color-with-alpha input[type="range"] {
            width: 60px;
            height: 4px;
        }

        .alpha-value {
            font-size: 0.7rem;
            color: #888;
            width: 30px;
        }

        .section-block-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .section-block-controls span {
            flex: 1;
            font-size: 0.85rem;
        }

        .section-block-controls .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Panel - Editor -->
        <div class="editor-panel">
            <div class="panel-header">
                <h2>Editor</h2>
            </div>
            <div class="panel-content">
                <!-- Import Data Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üìã Import Data</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="handlePaste()">Paste</button>
                            <button class="btn btn-secondary" onclick="handleAdd()" id="addBtn" disabled>Add</button>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label>Or paste HTML here manually:</label>
                            <textarea id="manualPasteInput" rows="4" placeholder="Paste your HTML content here..."></textarea>
                            <button class="btn btn-secondary btn-small" onclick="handleManualPaste()" style="margin-top: 8px;">Import from textarea</button>
                        </div>
                    </div>
                </div>

                <!-- Header Data Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üìù Header Data</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Card Name</label>
                            <input type="text" id="cardNameInput" placeholder="Character name..." oninput="updatePreview()">
                        </div>
                        
                        <div class="form-group">
                            <label>Pills / Badges</label>
                            <div id="pillsContainer"></div>
                            <button class="btn btn-secondary btn-small" onclick="addPill()" style="margin-top: 8px;">+ Add Pill</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Profile Image</label>
                            <div class="image-controls">
                                <button class="btn btn-secondary btn-small" onclick="document.getElementById('imageUpload').click()">Upload</button>
                                <button class="btn btn-danger btn-small" onclick="removeImage()">Remove</button>
                                <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search & Replace Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üîç Search & Replace</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Find</label>
                                <input type="text" id="searchInput" placeholder="Text to find...">
                            </div>
                            <div class="form-group">
                                <label>Replace with</label>
                                <input type="text" id="replaceInput" placeholder="Replacement text...">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="executeReplace()">Replace All</button>
                            <button class="btn btn-secondary" onclick="undoReplace()" id="undoBtn" disabled>Undo</button>
                        </div>
                    </div>
                </div>

                <!-- Quote Color Mapping Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üé® Quote Color Mapping</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="quoteColorMappings">
                        <p style="font-size: 0.8rem; color: #888;">Detected quote colors will appear here after pasting content.</p>
                    </div>
                </div>

                <!-- Collapsible Sections -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üìÇ Sections Management</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="toggle-group">
                            <div class="toggle" id="detailsToggle" onclick="toggleDetails()"></div>
                            <span class="toggle-label">Wrap blocks in &lt;details&gt;</span>
                        </div>
                        <div id="summaryInputs" style="margin-top: 12px; display: none;"></div>
                        <div id="sectionControls" style="margin-top: 12px;"></div>
                    </div>
                </div>

                <!-- Global Styles Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üåê Global Styles</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Font Family</label>
                            <select id="globalFont" onchange="updateGlobalFont()">
                                <option value="'Segoe UI', Roboto, Arial, sans-serif">Segoe UI / Roboto</option>
                                <option value="Arial, Helvetica, sans-serif">Arial</option>
                                <option value="Georgia, 'Times New Roman', serif">Georgia</option>
                                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="Verdana, Geneva, sans-serif">Verdana</option>
                            </select>
                        </div>
                        <div class="toggle-group">
                            <div class="toggle" id="oddEvenToggle" onclick="toggleOddEven()"></div>
                            <span class="toggle-label">Split Odd/Even Block Styles</span>
                        </div>
                    </div>
                </div>

                <!-- Style Editors (generated dynamically) -->
                <div id="styleEditors"></div>

                <!-- Templates & Presets Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üíæ Templates & Presets</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Load Template</label>
                            <select id="presetSelect">
                                <option value="">-- Select Template --</option>
                            </select>
                        </div>
                        <div style="margin: 12px 0; padding: 12px; background: #2a2a2a; border-radius: 6px;">
                            <p style="font-size: 0.8rem; color: #888; margin-bottom: 8px;">
                                Current: <strong id="currentTemplateName">Vertical Dark</strong>
                            </p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="downloadCurrentTemplate()">Download Template</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('templateUpload').click()">Upload Template</button>
                            <input type="file" id="templateUpload" accept=".json" style="display: none;" onchange="uploadTemplate(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Preview -->
        <div class="preview-panel">
            <div class="preview-header">
                <h2 id="previewTitle">Preview</h2>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="editBtn" onclick="toggleEditMode()">Edit HTML</button>
                </div>
            </div>
            <div class="preview-content">
                <div class="preview-frame" id="previewFrame">
                    <p style="color: #666; text-align: center; padding: 40px;">Paste content to see preview</p>
                </div>
                <textarea class="edit-textarea hidden" id="editTextarea" oninput="updateFromEdit()"></textarea>
            </div>
            <div class="output-section">
                <button class="btn btn-success" onclick="generateOutput()" style="margin-bottom: 12px;">Generate Output</button>
                <textarea class="output-textarea" id="outputTextarea" readonly placeholder="Click 'Generate Output' to see the final HTML..."></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="copyOutput(event)">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay hidden" id="confirmModal">
        <div class="modal">
            <h3>‚ö†Ô∏è Overwrite Data?</h3>
            <p>You already have content. Pasting will replace all existing data. Continue?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmPaste()">Overwrite</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        const state = {
            textBlocks: [],
            cardName: '',
            pills: [],
            imageData: '',
            hasContent: false,
            isEditMode: false,
            isOddEvenMode: false,
            isDetailsMode: false,
            summaryTexts: [],
            quoteColorMap: {},
            detectedColors: new Set(),
            searchReplaceBackup: null,
            currentTemplate: 'vertical_dark',
            templateStyles: {},
            globalFont: "'Segoe UI', Roboto, Arial, sans-serif"
        };

        // ============================================
        // QUOTE COLOR DEFINITIONS
        // ============================================
        
        const QUOTE_COLORS = {
            '#8BE9FD': 'smallquote',
            '#FFB86C': 'bigquote'
        };

        const PARAGRAPH_COLORS = ['#F8F8F2', '#FFFFFF', '#E0E0E0', '#D4D4D4', '#CCCCCC'];

        // ============================================
        // TEMPLATE DEFINITIONS
        // ============================================

        const templateDefinitions = {
            elements: {
                root_container: { label: 'Root Container', description: 'The outermost wrapper' },
                image_container: { label: 'Image Container', description: 'Wrapper for the profile image' },
                content_container: { label: 'Content Container', description: 'Wrapper for all text content' },
                header_container: { label: 'Header Container', description: 'Contains card name and pills' },
                card_name: { label: 'Card Name', description: 'Character/card name text' },
                text_container: { label: 'Text Container', description: 'Wrapper for all text blocks' },
                text_block: { label: 'Text Block', description: 'Individual message block', supportsOddEven: true },
                paragraph: { label: 'Paragraph', description: 'Normal narrative text', supportsOddEven: true },
                smallquote: { label: 'Small Quote', description: 'Inner thoughts, whispers', supportsOddEven: true },
                bigquote: { label: 'Big Quote', description: 'Speech, dialogue', supportsOddEven: true },
                footer_container: { label: 'Footer Container', description: 'Footer wrapper' },
                footer_text: { label: 'Footer Text', description: 'Attribution text' }
            }
        };

        // ============================================
        // TEMPLATE PRESETS
        // ============================================

        const templatePresets = {
            vertical_dark: {
                name: 'Vertical Dark',
                description: 'Image on top, content below',
                structure: 'vertical',
                styles: {
                    root_container: {
                        'background': '#000000',
                        'border': '0 solid #4b5563',
                        'border-radius': '12px',
                        'padding': '20px',
                        'margin': '1rem auto',
                        'max-width': '600px',
                        'box-shadow': '0px 4px 12px rgba(0,0,0,0.15)',
                        'display': 'flex',
                        'flex-direction': 'column',
                        'align-items': 'center'
                    },
                    image_container: {
                        'width': '80px',
                        'height': '80px',
                        'border-radius': '50%',
                        'border': '3px solid #4b5563',
                        'background-size': 'cover',
                        'background-position': 'center',
                        'background-repeat': 'no-repeat',
                        'margin-bottom': '1rem'
                    },
                    content_container: { 'width': '100%' },
                    header_container: {
                        'display': 'flex',
                        'flex-direction': 'column',
                        'align-items': 'center',
                        'margin-bottom': '1rem'
                    },
                    card_name: { 'color': '#f8f8f2', 'font-size': '1.5rem', 'font-weight': '600', 'margin': '0' },
                    llm_badge: {
                        'background': '#000000',
                        'color': '#f8f8f2',
                        'border': '1px solid #4b5563',
                        'border-radius': '16px',
                        'padding': '0.25rem 0.75rem',
                        'font-size': '0.8rem',
                        'margin-top': '0.5rem',
                        'display': 'inline-block'
                    },
                    text_container: { 'border-top': '1px solid #4b5563', 'padding-top': '1rem' },
                    text_block: { 'background': 'transparent', 'border': '0 solid #4b5563', 'border-radius': '0', 'padding': '0', 'margin': '0 0 1rem 0' },
                    paragraph: { 'color': '#f8f8f2', 'font-size': '1rem', 'line-height': '1.6', 'padding': '0', 'margin': '0' },
                    smallquote: { 'color': '#8BE9FD', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #8BE9FD' },
                    bigquote: { 'color': '#FFB86C', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #FFB86C' },
                    footer_container: { 'border-top': '1px solid #4b5563', 'padding-top': '0.75rem', 'text-align': 'center', 'margin-top': '1rem' },
                    footer_text: { 'color': '#64748b', 'font-size': '0.75rem', 'opacity': '0.7' }
                }
            },
            horizontal_dark: {
                name: 'Horizontal Dark',
                description: 'Image on left, content on right',
                structure: 'horizontal',
                styles: {
                    root_container: {
                        'background': '#000000',
                        'border': '1px solid #4b5563',
                        'border-radius': '16px 12px 12px 16px',
                        'padding': '10px',
                        'margin': '1rem auto',
                        'max-width': '700px',
                        'box-shadow': '0px 4px 12px rgba(0,0,0,0.15)',
                        'display': 'flex',
                        'flex-direction': 'row'
                    },
                    image_container: {
                        'width': '200px',
                        'min-height': '300px',
                        'border-radius': '8px 0 0 8px',
                        'background-size': 'cover',
                        'background-position': 'center',
                        'background-repeat': 'no-repeat',
                        'flex-shrink': '0'
                    },
                    content_container: { 'flex': '1', 'padding': '1rem', 'margin-left': '10px' },
                    header_container: { 'display': 'flex', 'align-items': 'start', 'justify-content': 'space-between', 'margin-bottom': '1rem' },
                    card_name: { 'color': '#f8f8f2', 'font-size': '1.5rem', 'font-weight': '600', 'margin': '0' },
                    llm_badge: { 'background': '#000000', 'color': '#f8f8f2', 'border': '1px solid #4b5563', 'border-radius': '16px', 'padding': '0.25rem 0.75rem', 'font-size': '0.8rem', 'display': 'inline-block' },
                    text_container: { 'padding': '0' },
                    text_block: { 'background': 'transparent', 'border': '0 solid #4b5563', 'border-radius': '0', 'padding': '0', 'margin': '0 0 1rem 0' },
                    text_block_even: { 'background': '#9c7373', 'border': '0 solid #4b5563', 'border-radius': '5px', 'padding': '5px', 'margin': '0 0 1rem 0' },
                    paragraph: { 'color': '#f8f8f2', 'font-size': '1rem', 'line-height': '1.6', 'padding': '0', 'margin': '0' },
                    smallquote: { 'color': '#8BE9FD', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #8BE9FD' },
                    bigquote: { 'color': '#FFB86C', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #FFB86C' },
                    footer_container: { 'border-top': '1px solid #4b5563', 'padding-top': '0.75rem', 'text-align': 'center', 'margin-top': '1rem' },
                    footer_text: { 'color': '#64748b', 'font-size': '0.75rem', 'opacity': '0.7' }
                }
            },
            horizontal_light: {
                name: 'Horizontal Light',
                description: 'Image on left, light theme',
                structure: 'horizontal',
                styles: {
                    root_container: { 'background': '#ffffff', 'border': '1px solid #e0e0e0', 'border-radius': '16px 12px 12px 16px', 'padding': '10px', 'margin': '1rem auto', 'max-width': '700px', 'box-shadow': '0px 4px 12px rgba(0,0,0,0.08)', 'display': 'flex', 'flex-direction': 'row' },
                    image_container: { 'width': '200px', 'min-height': '300px', 'border-radius': '8px 0 0 8px', 'background-size': 'cover', 'background-position': 'center', 'background-repeat': 'no-repeat', 'flex-shrink': '0' },
                    content_container: { 'flex': '1', 'padding': '1rem', 'margin-left': '10px' },
                    header_container: { 'display': 'flex', 'align-items': 'start', 'justify-content': 'space-between', 'margin-bottom': '1rem' },
                    card_name: { 'color': '#1a1a1a', 'font-size': '1.5rem', 'font-weight': '600', 'margin': '0' },
                    llm_badge: { 'background': '#f5f5f5', 'color': '#333333', 'border': '1px solid #d0d0d0', 'border-radius': '16px', 'padding': '0.25rem 0.75rem', 'font-size': '0.8rem', 'display': 'inline-block' },
                    text_container: { 'padding': '0' },
                    text_block: { 'background': 'transparent', 'border': '0 solid #e0e0e0', 'border-radius': '0', 'padding': '0', 'margin': '0 0 1rem 0' },
                    paragraph: { 'color': '#1a1a1a', 'font-size': '1rem', 'line-height': '1.6', 'padding': '0', 'margin': '0' },
                    smallquote: { 'color': '#0891b2', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #0891b2' },
                    bigquote: { 'color': '#d97706', 'background': 'transparent', 'font-style': 'normal', 'padding': '0', 'margin': '0', 'border': '0 none #d97706' },
                    footer_container: { 'border-top': '1px solid #e0e0e0', 'padding-top': '0.75rem', 'text-align': 'center', 'margin-top': '1rem' },
                    footer_text: { 'color': '#6b7280', 'font-size': '0.75rem', 'opacity': '0.7' }
                }
            }
        };

        // ============================================
        // UI HELPERS
        // ============================================

        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('hidden');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function updateGlobalFont() {
            state.globalFont = document.getElementById('globalFont').value;
            updatePreview();
        }

        // ============================================
        // TEMPLATE MANAGEMENT
        // ============================================

        function loadTemplate(templateKey) {
            if (!templatePresets[templateKey]) return;
            
            state.currentTemplate = templateKey;
            state.templateStyles = JSON.parse(JSON.stringify(templatePresets[templateKey].styles));
            
            document.getElementById('currentTemplateName').textContent = templatePresets[templateKey].name;
            
            generateStyleEditors();
            updatePreview();
        }

        function updatePresetDropdown() {
            const select = document.getElementById('presetSelect');
            select.innerHTML = '<option value="">-- Select Template --</option>';
            
            for (const [key, preset] of Object.entries(templatePresets)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${preset.name} - ${preset.description}`;
                select.appendChild(option);
            }
        }

        function downloadCurrentTemplate() {
            const template = {
                name: 'Custom Template',
                description: 'Exported from Text Formatter',
                structure: templatePresets[state.currentTemplate]?.structure || 'vertical',
                styles: state.templateStyles,
                globalFont: state.globalFont,
                isOddEvenMode: state.isOddEvenMode
            };
            
            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'text-formatter-template.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function uploadTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const template = JSON.parse(e.target.result);
                    
                    const customKey = 'custom_' + Date.now();
                    templatePresets[customKey] = {
                        name: template.name || 'Custom',
                        description: template.description || 'Imported template',
                        structure: template.structure || 'vertical',
                        styles: template.styles
                    };
                    
                    state.currentTemplate = customKey;
                    state.templateStyles = JSON.parse(JSON.stringify(template.styles));
                    state.globalFont = template.globalFont || state.globalFont;
                    state.isOddEvenMode = template.isOddEvenMode || false;
                    
                    document.getElementById('currentTemplateName').textContent = template.name || 'Custom';
                    
                    updatePresetDropdown();
                    generateStyleEditors();
                    updatePreview();
                    
                    alert('Template loaded successfully!');
                } catch (err) {
                    console.error('Failed to parse template:', err);
                    alert('Invalid template file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============================================
        // STYLE EDITOR GENERATION
        // ============================================

        function generateStyleEditors() {
            const container = document.getElementById('styleEditors');
            container.innerHTML = '';
            
            for (const [elementKey, elementDef] of Object.entries(templateDefinitions.elements)) {
                if (elementKey.endsWith('_even')) continue;
                
                const section = createStyleSection(elementKey, elementDef);
                container.appendChild(section);
                
                if (elementDef.supportsOddEven && state.isOddEvenMode) {
                    const evenSection = createStyleSection(elementKey + '_even', {
                        ...elementDef,
                        label: elementDef.label + ' (Even)'
                    });
                    container.appendChild(evenSection);
                }
            }
        }

        function createStyleSection(elementKey, elementDef) {
            const section = document.createElement('div');
            section.className = 'section';
            section.id = `section_${elementKey}`;
            
            const styles = state.templateStyles[elementKey] || {};
            const labelSuffix = elementDef.supportsOddEven && state.isOddEvenMode && !elementKey.endsWith('_even') ? ' (Odd)' : '';
            
            let propertiesHTML = '';
            for (const [prop, value] of Object.entries(styles)) {
                propertiesHTML += createPropertyInput(elementKey, prop, value);
            }
            
            section.innerHTML = `
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üé® ${elementDef.label}${labelSuffix}</h3>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <p style="font-size: 0.75rem; color: #666; margin-bottom: 12px;">${elementDef.description || ''}</p>
                    ${propertiesHTML}
                    <div class="btn-group" style="margin-top: 12px;">
                        <button class="btn btn-secondary btn-small" onclick="addProperty('${elementKey}')">+ Add Property</button>
                    </div>
                </div>
            `;
            
            return section;
        }

        function createPropertyInput(elementKey, prop, value) {
            const isColor = (prop === 'color' || prop === 'background-color');
            const isBorder = prop === 'border';
            const isBackground = (prop === 'background');
            
            let inputHTML = '';
            
            if (isBorder) {
                const borderMatch = (value || '').match(/^(\d+(?:px)?)\s+(solid|dashed|dotted|none)\s+(#?\w+)?/);
                const width = borderMatch ? borderMatch[1].replace('px', '') : '0';
                const style = borderMatch ? borderMatch[2] : 'solid';
                const color = borderMatch ? borderMatch[3] : '#4b5563';
                
                inputHTML = `
                    <div class="border-editor">
                        <input type="number" value="${width}" min="0" onchange="updateBorderStyle('${elementKey}', '${prop}', this.parentElement)">
                        <select onchange="updateBorderStyle('${elementKey}', '${prop}', this.parentElement)">
                            <option value="none" ${style === 'none' ? 'selected' : ''}>none</option>
                            <option value="solid" ${style === 'solid' ? 'selected' : ''}>solid</option>
                            <option value="dashed" ${style === 'dashed' ? 'selected' : ''}>dashed</option>
                            <option value="dotted" ${style === 'dotted' ? 'selected' : ''}>dotted</option>
                        </select>
                        <input type="color" value="${color && color.startsWith('#') ? color : '#4b5563'}" onchange="updateBorderStyle('${elementKey}', '${prop}', this.parentElement)">
                    </div>
                `;
            } else if (isBackground || isColor) {
                const colorValue = (value && value.startsWith('#')) ? value.substring(0, 7) : '#000000';
                let alpha = 1;
                if (value && value.startsWith('rgba')) {
                    const match = value.match(/rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*([\d.]+)\s*\)/);
                    if (match) alpha = parseFloat(match[1]);
                }
                inputHTML = `
                    <div class="color-with-alpha">
                        <input type="color" value="${colorValue}" onchange="updateColorWithAlpha('${elementKey}', '${prop}', this.parentElement)">
                        <input type="range" min="0" max="1" step="0.1" value="${alpha}" onchange="updateColorWithAlpha('${elementKey}', '${prop}', this.parentElement)">
                        <span class="alpha-value">${Math.round(alpha * 100)}%</span>
                    </div>
                    <input type="text" value="${value || ''}" onchange="updateTemplateStyle('${elementKey}', '${prop}', this.value)" style="margin-top: 4px;">
                `;
            } else {
                inputHTML = `
                    <input type="text" value="${value || ''}" 
                        onchange="updateTemplateStyle('${elementKey}', '${prop}', this.value)">
                `;
            }
            
            return `
                <div class="style-property">
                    <div class="style-property-label">
                        ${prop}
                        <button style="float: right; background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 0.8rem;" 
                            onclick="removeProperty('${elementKey}', '${prop}')">‚úï</button>
                    </div>
                    <div class="style-property-input">
                        ${inputHTML}
                    </div>
                </div>
            `;
        }

        function updateColorWithAlpha(elementKey, prop, container) {
            const colorInput = container.querySelector('input[type="color"]');
            const alphaInput = container.querySelector('input[type="range"]');
            const alphaLabel = container.querySelector('.alpha-value');
            
            const hex = colorInput.value;
            const alpha = parseFloat(alphaInput.value);
            
            alphaLabel.textContent = `${Math.round(alpha * 100)}%`;
            
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            
            let colorValue;
            if (alpha < 1) {
                colorValue = `rgba(${r}, ${g}, ${b}, ${alpha})`;
            } else {
                colorValue = hex;
            }
            
            const textInput = container.parentElement.querySelector('input[type="text"]');
            if (textInput) textInput.value = colorValue;
            
            updateTemplateStyle(elementKey, prop, colorValue);
        }

        function updateBorderStyle(elementKey, prop, container) {
            const widthInput = container.querySelector('input[type="number"]');
            const styleSelect = container.querySelector('select');
            const colorInput = container.querySelector('input[type="color"]');
            
            const borderValue = `${widthInput.value}px ${styleSelect.value} ${colorInput.value}`;
            updateTemplateStyle(elementKey, prop, borderValue);
        }

        function updateTemplateStyle(elementKey, prop, value) {
            if (!state.templateStyles[elementKey]) {
                state.templateStyles[elementKey] = {};
            }
            state.templateStyles[elementKey][prop] = value;
            updatePreview();
        }

        function addProperty(elementKey) {
            const prop = prompt('Enter CSS property name (e.g., padding, margin, color):');
            if (!prop) return;
            
            if (!state.templateStyles[elementKey]) {
                state.templateStyles[elementKey] = {};
            }
            state.templateStyles[elementKey][prop] = '';
            
            generateStyleEditors();
        }

        function removeProperty(elementKey, prop) {
            if (state.templateStyles[elementKey]) {
                delete state.templateStyles[elementKey][prop];
                generateStyleEditors();
                updatePreview();
            }
        }

        // ============================================
        // TOGGLE FUNCTIONS
        // ============================================

        function toggleOddEven() {
            const toggle = document.getElementById('oddEvenToggle');
            toggle.classList.toggle('active');
            state.isOddEvenMode = toggle.classList.contains('active');
            
            if (state.isOddEvenMode) {
                for (const [key, def] of Object.entries(templateDefinitions.elements)) {
                    if (def.supportsOddEven && !state.templateStyles[key + '_even']) {
                        state.templateStyles[key + '_even'] = JSON.parse(JSON.stringify(state.templateStyles[key] || {}));
                    }
                }
            }
            
            generateStyleEditors();
            updatePreview();
        }

        function toggleDetails() {
            const toggle = document.getElementById('detailsToggle');
            toggle.classList.toggle('active');
            state.isDetailsMode = toggle.classList.contains('active');
            
            const summaryContainer = document.getElementById('summaryInputs');
            summaryContainer.style.display = state.isDetailsMode ? 'block' : 'none';
            
            if (state.isDetailsMode) {
                updateSummaryInputs();
            }
            
            updatePreview();
        }

        function updateSummaryInputs() {
            const container = document.getElementById('summaryInputs');
            
            if (state.textBlocks.length === 0) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: #666;">No sections yet.</p>';
                return;
            }
            
            container.innerHTML = state.textBlocks.map((_, index) => `
                <div class="summary-input-group">
                    <label>Section ${index + 1}</label>
                    <input type="text" value="${state.summaryTexts[index] || ''}" 
                        placeholder="Summary text..." 
                        onchange="updateSummaryText(${index}, this.value)">
                </div>
            `).join('');
        }

        function updateSummaryText(index, value) {
            state.summaryTexts[index] = value;
            updatePreview();
        }

        // ============================================
        // SECTION MANAGEMENT
        // ============================================

        function renderSectionControls() {
            const container = document.getElementById('sectionControls');
            
            if (state.textBlocks.length <= 1) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <label style="font-size: 0.8rem; color: #aaa; margin-bottom: 8px; display: block;">Manage Sections</label>
                ${state.textBlocks.map((_, index) => `
                    <div class="section-block-controls">
                        <span>Section ${index + 1}</span>
                        <button class="btn btn-secondary" onclick="moveSectionUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="btn btn-secondary" onclick="moveSectionDown(${index})" ${index === state.textBlocks.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="btn btn-danger" onclick="removeSection(${index})">√ó</button>
                    </div>
                `).join('')}
            `;
        }

        function moveSectionUp(index) {
            if (index <= 0) return;
            [state.textBlocks[index], state.textBlocks[index - 1]] = [state.textBlocks[index - 1], state.textBlocks[index]];
            [state.summaryTexts[index], state.summaryTexts[index - 1]] = [state.summaryTexts[index - 1], state.summaryTexts[index]];
            renderSectionControls();
            updateSummaryInputs();
            updatePreview();
        }

        function moveSectionDown(index) {
            if (index >= state.textBlocks.length - 1) return;
            [state.textBlocks[index], state.textBlocks[index + 1]] = [state.textBlocks[index + 1], state.textBlocks[index]];
            [state.summaryTexts[index], state.summaryTexts[index + 1]] = [state.summaryTexts[index + 1], state.summaryTexts[index]];
            renderSectionControls();
            updateSummaryInputs();
            updatePreview();
        }

        function removeSection(index) {
            if (state.textBlocks.length <= 1) {
                alert('Cannot remove the last section.');
                return;
            }
            state.textBlocks.splice(index, 1);
            state.summaryTexts.splice(index, 1);
            renderSectionControls();
            updateSummaryInputs();
            updatePreview();
        }

        // ============================================
        // PILL MANAGEMENT
        // ============================================

        function addPill(text = '', bgColor = '#000000', textColor = '#f8f8f2', borderColor = '#4b5563', link = '') {
            state.pills.push({
                text: text || 'New Pill',
                bgColor: bgColor,
                textColor: textColor,
                borderColor: borderColor,
                link: link
            });
            renderPills();
            updatePreview();
        }

        function updatePill(index, field, value) {
            if (state.pills[index]) {
                state.pills[index][field] = value;
                renderPills();
                updatePreview();
            }
        }

        function removePill(index) {
            state.pills.splice(index, 1);
            renderPills();
            updatePreview();
        }

        function renderPills() {
            const container = document.getElementById('pillsContainer');
            
            if (state.pills.length === 0) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: #666;">No pills added yet. Click "+ Add Pill" to create one.</p>';
                return;
            }
            
            container.innerHTML = state.pills.map((pill, index) => `
                <div class="pill-editor">
                    <input type="text" value="${pill.text}" placeholder="Pill text..." 
                        onchange="updatePill(${index}, 'text', this.value)" style="flex: 2;">
                    
                    <input type="text" value="${pill.link || ''}" placeholder="URL (optional)" 
                        onchange="updatePill(${index}, 'link', this.value)" style="flex: 2;">
                    
                    <div class="pill-editor-colors">
                        <label>BG</label>
                        <input type="color" value="${pill.bgColor}" 
                            onchange="updatePill(${index}, 'bgColor', this.value)" title="Background Color">
                    </div>
                    
                    <div class="pill-editor-colors">
                        <label>Text</label>
                        <input type="color" value="${pill.textColor}" 
                            onchange="updatePill(${index}, 'textColor', this.value)" title="Text Color">
                    </div>
                    
                    <div class="pill-editor-colors">
                        <label>Border</label>
                        <input type="color" value="${pill.borderColor}" 
                            onchange="updatePill(${index}, 'borderColor', this.value)" title="Border Color">
                    </div>
                    
                    <div class="pill-preview" style="background: ${pill.bgColor}; color: ${pill.textColor}; border: 1px solid ${pill.borderColor};">
                        ${pill.link ? 'üîó ' : ''}${pill.text}
                    </div>
                    
                    <button class="btn btn-danger btn-small" onclick="removePill(${index})" style="padding: 4px 8px;">√ó</button>
                </div>
            `).join('');
        }

        // ============================================
        // IMAGE HANDLING
        // ============================================

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                state.imageData = e.target.result;
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            state.imageData = '';
            document.getElementById('imageUpload').value = '';
            updatePreview();
        }

        // ============================================
        // PASTE HANDLING
        // ============================================

        async function handlePaste() {
            if (state.hasContent) {
                document.getElementById('confirmModal').classList.remove('hidden');
                return;
            }
            await executePaste(true);
        }

        async function confirmPaste() {
            closeModal();
            await executePaste(true);
        }

        async function executePaste(isNew = true) {
            try {
                const clipboardItems = await navigator.clipboard.read();
                let html = '';
                
                for (const item of clipboardItems) {
                    if (item.types.includes('text/html')) {
                        const blob = await item.getType('text/html');
                        html = await blob.text();
                        break;
                    }
                }
                
                if (!html) {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        html = `<p style="color: #F8F8F2">${text}</p>`;
                    }
                }
                
                if (html) {
                    processHTML(html, isNew);
                }
            } catch (err) {
                console.error('Failed to read clipboard:', err);
                alert('Could not read clipboard. Please use the manual paste textarea below.');
            }
        }

        function handleManualPaste() {
            const textarea = document.getElementById('manualPasteInput');
            const html = textarea.value.trim();
            
            if (!html) {
                alert('Please paste some content in the textarea first.');
                return;
            }
            
            const isNew = !state.hasContent;
            processHTML(html, isNew);
            textarea.value = '';
        }

        function processHTML(html, isNew) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const body = doc.body;
            
            const newBlock = parseTextContent(body);
            
            if (newBlock.length === 0) {
                alert('No valid content found in paste.');
                return;
            }
            
            if (isNew) {
                state.textBlocks = [newBlock];
                state.summaryTexts = ['Section 1'];
            } else {
                state.textBlocks.push(newBlock);
                state.summaryTexts.push(`Section ${state.textBlocks.length}`);
            }
            
            state.hasContent = true;
            document.getElementById('addBtn').disabled = false;
            
            updateSummaryInputs();
            renderSectionControls();
            renderQuoteColorMappings();
            updatePreview();
        }

        async function handleAdd() {
            await executePaste(false);
        }

        // ============================================
        // TEXT PARSING
        // ============================================

        function normalizeColor(color) {
            if (!color) return '';
            color = color.trim().toUpperCase();
            
            if (color.startsWith('RGB')) {
                const match = color.match(/RGB\((\d+),\s*(\d+),\s*(\d+)\)/i);
                if (match) {
                    const r = parseInt(match[1]).toString(16).padStart(2, '0');
                    const g = parseInt(match[2]).toString(16).padStart(2, '0');
                    const b = parseInt(match[3]).toString(16).padStart(2, '0');
                    return `#${r}${g}${b}`.toUpperCase();
                }
            }
            
            return color;
        }

        function isParagraphColor(color) {
            return PARAGRAPH_COLORS.includes(color);
        }

        function parseTextContent(container) {
            if (!container) return [];
            
            const elements = [];
            const children = container.children;
            
            for (let i = 0; i < children.length; i++) {
                const child = children[i];
                const text = child.textContent.trim();
                
                if (!text || text.length === 0) continue;
                
                const style = child.getAttribute('style') || '';
                const colorMatch = style.match(/(?:^|;)\s*color:\s*(#[a-fA-F0-9]{6}|#[a-fA-F0-9]{3}|rgb\([^)]+\)|[a-zA-Z]+)/i);
                
                if (colorMatch) {
                    const color = normalizeColor(colorMatch[1]);
                    
                    if (QUOTE_COLORS[color]) {
                        state.detectedColors.add(color);
                        
                        if (!state.quoteColorMap[color]) {
                            state.quoteColorMap[color] = QUOTE_COLORS[color];
                        }
                        
                        elements.push({ 
                            type: 'quote', 
                            quoteType: state.quoteColorMap[color],
                            originalColor: color,
                            content: text 
                        });
                    } else if (isParagraphColor(color)) {
                        elements.push({ type: 'paragraph', content: text });
                    } else {
                        state.detectedColors.add(color);
                        
                        if (!state.quoteColorMap[color]) {
                            state.quoteColorMap[color] = 'unknown';
                        }
                        
                        elements.push({ 
                            type: 'quote', 
                            quoteType: state.quoteColorMap[color],
                            originalColor: color,
                            content: text 
                        });
                    }
                } else if (text.length > 0) {
                    elements.push({ type: 'paragraph', content: text });
                }
            }
            
            return elements.filter(el => el.content && el.content.trim().length > 0);
        }

        // ============================================
        // QUOTE COLOR MAPPING
        // ============================================

        function renderQuoteColorMappings() {
            const container = document.getElementById('quoteColorMappings');
            
            if (state.detectedColors.size === 0) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: #888;">Detected quote colors will appear here after pasting content.</p>';
                return;
            }
            
            container.innerHTML = Array.from(state.detectedColors).map(color => `
                <div class="quote-mapping">
                    <div class="color-preview" style="background: ${color};"></div>
                    <code style="font-size: 0.75rem; color: #aaa;">${color}</code>
                    <select onchange="updateQuoteColorMap('${color}', this.value)">
                        <option value="smallquote" ${state.quoteColorMap[color] === 'smallquote' ? 'selected' : ''}>Small Quote</option>
                        <option value="bigquote" ${state.quoteColorMap[color] === 'bigquote' ? 'selected' : ''}>Big Quote</option>
                        <option value="paragraph" ${state.quoteColorMap[color] === 'paragraph' ? 'selected' : ''}>Paragraph (ignore)</option>
                        <option value="unknown" ${state.quoteColorMap[color] === 'unknown' ? 'selected' : ''}>Unknown</option>
                    </select>
                </div>
            `).join('');
        }

        function updateQuoteColorMap(color, quoteType) {
            state.quoteColorMap[color] = quoteType;
            
            for (let block of state.textBlocks) {
                for (let element of block) {
                    if (element.originalColor === color) {
                        if (quoteType === 'paragraph') {
                            element.type = 'paragraph';
                        } else {
                            element.type = 'quote';
                            element.quoteType = quoteType;
                        }
                    }
                }
            }
            
            updatePreview();
        }

        // ============================================
        // SEARCH & REPLACE
        // ============================================

        function executeReplace() {
            const search = document.getElementById('searchInput').value;
            const replace = document.getElementById('replaceInput').value;
            
            if (!search) {
                alert('Please enter text to search for.');
                return;
            }
            
            state.searchReplaceBackup = JSON.parse(JSON.stringify(state.textBlocks));
            
            for (let block of state.textBlocks) {
                for (let element of block) {
                    element.content = element.content.split(search).join(replace);
                }
            }
            
            document.getElementById('undoBtn').disabled = false;
            updatePreview();
        }

        function undoReplace() {
            if (state.searchReplaceBackup) {
                state.textBlocks = state.searchReplaceBackup;
                state.searchReplaceBackup = null;
                document.getElementById('undoBtn').disabled = true;
                updatePreview();
            }
        }

        // ============================================
        // EDIT MODE
        // ============================================

        function toggleEditMode() {
            state.isEditMode = !state.isEditMode;
            
            const previewFrame = document.getElementById('previewFrame');
            const editTextarea = document.getElementById('editTextarea');
            const editBtn = document.getElementById('editBtn');
            
            if (state.isEditMode) {
                editTextarea.value = previewFrame.innerHTML;
                previewFrame.classList.add('hidden');
                editTextarea.classList.remove('hidden');
                editBtn.textContent = 'Preview';
                editBtn.classList.remove('btn-secondary');
                editBtn.classList.add('btn-success');
            } else {
                previewFrame.innerHTML = editTextarea.value;
                editTextarea.classList.add('hidden');
                previewFrame.classList.remove('hidden');
                editBtn.textContent = 'Edit HTML';
                editBtn.classList.remove('btn-success');
                editBtn.classList.add('btn-secondary');
            }
        }

        function updateFromEdit() {
            // Live update if needed
        }

        // ============================================
        // STYLE GENERATION
        // ============================================

        function generateInlineStyle(elementKey) {
            const styles = state.templateStyles[elementKey];
            if (!styles) return '';
            
            return Object.entries(styles)
                .map(([prop, value]) => `${prop}: ${value}`)
                .join('; ');
        }

        // ============================================
        // HTML GENERATION
        // ============================================

        function generatePillsHTML() {
            if (state.pills.length === 0) return '';
            
            return state.pills.map(pill => {
                const style = `background: ${pill.bgColor}; color: ${pill.textColor}; border: 1px solid ${pill.borderColor}; border-radius: 16px; padding: 0.25rem 0.75rem; font-size: 0.8rem; display: inline-flex; align-items: center; min-height: 24px; line-height: 1.4; margin: 0 4px 4px 0; text-decoration: none;`;
                
                if (pill.link) {
                    return `<a href="${pill.link}" style="${style}" target="_blank">${pill.text}</a>`;
                }
                return `<span style="${style}">${pill.text}</span>`;
            }).join('\n            ');
        }

        function generateTextBlocksHTML() {
            let blocksHTML = '';
            
            for (let i = 0; i < state.textBlocks.length; i++) {
                const isEven = i % 2 === 1;
                const blockStyleKey = state.isOddEvenMode && isEven ? 'text_block_even' : 'text_block';
                const blockStyle = generateInlineStyle(blockStyleKey) || generateInlineStyle('text_block');
                
                let blockContent = '';
                
                for (const element of state.textBlocks[i]) {
                    const paraStyleKey = state.isOddEvenMode && isEven ? 'paragraph_even' : 'paragraph';
                    const paraStyle = generateInlineStyle(paraStyleKey) || generateInlineStyle('paragraph');
                    
                    if (element.type === 'paragraph') {
                        blockContent += `<p style="${paraStyle}">${element.content}</p>\n`;
                    } else if (element.type === 'quote') {
                        const baseQuoteKey = element.quoteType === 'smallquote' ? 'smallquote' : 'bigquote';
                        const quoteStyleKey = state.isOddEvenMode && isEven ? `${baseQuoteKey}_even` : baseQuoteKey;
                        const quoteStyle = generateInlineStyle(quoteStyleKey) || generateInlineStyle(baseQuoteKey);
                        blockContent += `<p style="${paraStyle}; ${quoteStyle}">${element.content}</p>\n`;
                    }
                }
                
                if (state.isDetailsMode) {
                    blocksHTML += `
        <details>
            <summary>${state.summaryTexts[i] || `Section ${i + 1}`}</summary>
            <div style="${blockStyle}">
                ${blockContent}
            </div>
        </details>\n`;
                } else {
                    blocksHTML += `
        <div style="${blockStyle}">
            ${blockContent}
        </div>\n`;
                }
            }
            
            return blocksHTML;
        }

        function generateFullHTML() {
            const preset = templatePresets[state.currentTemplate];
            const isHorizontal = preset?.structure === 'horizontal';
            
            const rootStyle = generateInlineStyle('root_container');
            const imageStyle = generateInlineStyle('image_container');
            const contentStyle = generateInlineStyle('content_container');
            const headerStyle = generateInlineStyle('header_container');
            const cardNameStyle = generateInlineStyle('card_name');
            const textContainerStyle = generateInlineStyle('text_container');
            const footerStyle = generateInlineStyle('footer_container');
            const footerTextStyle = generateInlineStyle('footer_text');
            
            const cardName = document.getElementById('cardNameInput').value || 'Character Name';
            const pillsHTML = generatePillsHTML();
            const textBlocksHTML = generateTextBlocksHTML();
            
            const imageHTML = state.imageData 
                ? `<div style="${imageStyle}; background-image: url('${state.imageData}');"></div>` 
                : `<div style="${imageStyle}; background: #333;"></div>`;
            
            let html = '';
            
            if (isHorizontal) {
                html = `
<div style="font-family: ${state.globalFont}; ${rootStyle}">
    ${imageHTML}
    <div style="${contentStyle}">
        <div style="${headerStyle}">
            <h2 style="${cardNameStyle}">${cardName}</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                ${pillsHTML}
            </div>
        </div>
        <div style="${textContainerStyle}">
            ${textBlocksHTML}
        </div>
        <div style="${footerStyle}">
            <span style="${footerTextStyle}">Generated with Text Formatter</span>
        </div>
    </div>
</div>`;
            } else {
                html = `
<div style="font-family: ${state.globalFont}; ${rootStyle}">
    ${imageHTML}
    <div style="${contentStyle}">
        <div style="${headerStyle}">
            <h2 style="${cardNameStyle}">${cardName}</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 8px;">
                ${pillsHTML}
            </div>
        </div>
        <div style="${textContainerStyle}">
            ${textBlocksHTML}
        </div>
        <div style="${footerStyle}">
            <span style="${footerTextStyle}">Generated with Text Formatter</span>
        </div>
    </div>
</div>`;
            }
            
            return html.trim();
        }

        // ============================================
        // PREVIEW & OUTPUT
        // ============================================

        function updatePreview() {
            const preview = document.getElementById('previewFrame');
            
            if (!state.hasContent && state.pills.length === 0) {
                preview.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Paste content to see preview</p>';
                return;
            }
            
            preview.innerHTML = generateFullHTML();
        }

        function generateOutput() {
            const output = generateFullHTML();
            document.getElementById('outputTextarea').value = output;
        }

        async function copyOutput(event) {
            const output = document.getElementById('outputTextarea').value;
            
            try {
                const htmlBlob = new Blob([output], { type: 'text/html' });
                const textBlob = new Blob([output], { type: 'text/plain' });
                
                const clipboardItem = new ClipboardItem({
                    'text/html': htmlBlob,
                    'text/plain': textBlob
                });
                
                await navigator.clipboard.write([clipboardItem]);
                
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);
            } catch (err) {
                try {
                    await navigator.clipboard.writeText(output);
                    const btn = event.target;
                    btn.textContent = 'Copied (text)!';
                    setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
                } catch (fallbackErr) {
                    console.error('Failed to copy:', fallbackErr);
                    alert('Failed to copy to clipboard.');
                }
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.getElementById('presetSelect').addEventListener('change', function() {
            if (this.value) {
                loadTemplate(this.value);
                this.value = '';
            }
        });

        document.getElementById('cardNameInput').addEventListener('input', function() {
            state.cardName = this.value;
        });

        // Initialize
        loadTemplate('vertical_dark');
        updatePresetDropdown();
        renderPills();
    </script>
</body>
</html>
